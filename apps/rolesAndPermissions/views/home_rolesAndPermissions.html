<style>
.permission-card {
  display: flex;
  align-items: center;
  padding: 16px;
  width: 100%;
  margin: 10px 0;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.permission-icon {
  flex-shrink: 0;
  font-size: 32px;
  color: var(--primary);
  margin-right: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.permission-text h4 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: #333;
  flex: 1;
}

.permission-text h5 {
  margin: 4px 0 0 0;
  font-size: 14px;
  font-weight: 400;
  color: #666;
  color: var(--primary);
}

.search-container {
  position: relative;
  display: flex;
  align-items: center;
  width: 100%;
  padding: 6px 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  background-color: white;
}

</style>

<div class="p-4">
    <div class="section">
        <input-field label="Nombre del rol" placeholder="Ingrese el nombre del rol"></input-field>
    </div>
</div>

<!---here is save all the module of the permissions--->
<div id="permissions-container">

</div>



<button class="btn btn-add btn-success">Guardar</button>
<br><br>


<script>
    // Function to update the permission count per module
  function get_module_permission_text(switchList) {
    const textTranslatePermissions = window.translate_text('rolesAndPermissions.subtext.permissions');
    const textTranslateActivate = window.translate_text('rolesAndPermissions.subtext.permissions.activate');
    

    let countActive = 0;
    const globalStatus=document.getElementById('activate_all_the_permissions_0').getChecked();
    switchList.forEach(sw => {
      if(globalStatus){
        document.getElementById(sw).setChecked(true)
      }


      if(document.getElementById(sw).getChecked()){
        countActive++;
      }
    });


    //return the answer of the permissions that the module have activate, if the countActive is 0 return 0
    return `${switchList.length } ${textTranslatePermissions} - ${countActive} ${textTranslateActivate}`;
  }


  function update_module_permission_count(value) {
    for (let app of switchInfo) {
      const newDesc = get_module_permission_text(app.switch);

      //update the attribute des and update the information of the permittions that the module have activate
      app.module.setAttribute('desc', newDesc);
      const sidebarDesc = document.querySelector(`.plus-modules-sidebar li[data-index='${switchInfo.indexOf(app)}'] .plus-modules-desc`);
      if (sidebarDesc) sidebarDesc.textContent = newDesc;
    }
  }

  (async()=>{
     //this is for save all the permissions of the apps with his reference of the web for after
     //we can know how many permissions have each module
    let switchInfo=[];

    //here we will get all the permissions of the erp from the backend 
    const backend=await send_message_to_the_server('rolesAndPermissions/get_all_the_permissions_of_the_erp/', {}, false);
    if(backend.success){
      //get all the permissions of the server and update the UI for render all the permissions
      const apps=backend.answer;
      const container = document.getElementById("permissions-container");
      //container.innerHTML = ''; // Clear existing content

      const containerPermissions = document.createElement('plus-modules');

      const textTranslateSearch=window.t('message.search');
      const textTranslatePermissions=window.translate_text('rolesAndPermissions.subtext.permissions');
      const textTranslateActivate=window.translate_text('rolesAndPermissions.subtext.permissions.activate');

      //print all the permissions in his module
      let account_module=0;
      Object.entries(apps).forEach(([appKey, appData]) => {
          //if there is no data, skip
          if(!appData || !appData.permissions) return;

          //if exist information now we will to create the module with his permissions
          //create the module father
          const plusModule = document.createElement("plus-module");
          plusModule.setAttribute("name", appData.translate.es.app_name || appKey);
          plusModule.setAttribute("desc", `${appData.permissions.length} ${textTranslatePermissions} - 0 ${textTranslateActivate}`);
          plusModule.setAttribute("icon", appData.character?.icon || "fi-rr-box");

          //create the weaker search
          const searchDiv = document.createElement("div");
          searchDiv.classList.add("search-container");
          searchDiv.innerHTML = `
            <i class="fi fi-rs-search search-icon"></i>
            <input type="text" class="search-input" placeholder='${textTranslateSearch}'>
          `;
          
          const searchInput = searchDiv.querySelector(".search-input");  //this is for save the reference of the search input
          plusModule.appendChild(searchDiv);

          // add title + switch for "activate all the permissions"
          const titlePerms = document.createElement("div");
          titlePerms.className = "section";
          titlePerms.innerHTML = `
              <div class="permission-card">
                <div class="permission-icon">
                  <i class="${appData.character?.icon || 'fi-rr-box'}"></i>
                </div>
                <div class="permission-text">
                  <h4>${appData.translate?.es?.app_name || appKey}</h4>
                  <h5 class="permission-account">${appData.translate.es.description}</h5>
                </div>
              </div>


              <plus-switch text="rolesAndPermissions.subtext.permissions.activate-all" t='rolesAndPermissions.subtext.permissions.activate-all' id='activate_all_the_permissions_${account_module}'></plus-switch>
          `;
          

          const listOfPermissions=[]
          const labelAccount=titlePerms.querySelector(".permission-account"); //this is for after update the count of permissions
          

          plusModule.appendChild(titlePerms);

          //here we will print all the permissions of the module
          const sectionDiv = document.createElement("div");
          sectionDiv.classList.add("section");

          appData.permissions.forEach(permKey => {
            const permission = document.createElement("plus-switch");
            permission.setAttribute("text", appData.translate.es[permKey] || permKey);
            
            permission.setAttribute("name", permKey);
            permission.setAttribute("id", permKey);
            permission.setAttribute('onclick', 'update_module_permission_count');

            listOfPermissions.push(permKey);
            sectionDiv.appendChild(permission);
          });

          plusModule.appendChild(sectionDiv);
          containerPermissions.appendChild(plusModule);

          //now we will to save the reference of the label for update the count of permissions
          //when this we will to can update the infomation of the label when a switch is activated or desactivated
          switchInfo.push({
            module: plusModule,
            switch: listOfPermissions,
          });


          // Add event listener for search functionality
          containerPermissions.addEventListener("input", e => {
            if (e.target.matches(".search-input")) {
              const term = e.target.value.toLowerCase();

              //get the switch of the module and show or hide the switch
              const sectionDiv = e.target.closest("plus-modules")
              console.log(sectionDiv)
              const switches = sectionDiv.querySelectorAll("plus-switch");


              switches.forEach(sw => {
                const text = (sw.getAttribute("text") || "").toLowerCase();
                sw.style.display = text.includes(term) ? "" : "none";
              });
            }
          });
        
          account_module++;
        });





      container.appendChild(containerPermissions);
    }

    

    window.switchInfo=switchInfo;
  })();
</script>
