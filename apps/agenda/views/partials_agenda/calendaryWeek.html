<style>
  .calendary-week-calendar {
    display: grid;
    grid-template-columns: 100px repeat(7, 1fr);
    width: 100%;
    height: 100vh;
    position: relative;
    overflow-x: auto;
    /* permitir scroll horizontal en mÃ³viles */
  }


  .calendary-week-header {
    display: contents;
  }

  .calendary-week-header div {
    background: #f0f0f0;
    text-align: center;
    padding: 10px;
    font-weight: bold;
    border: 1px solid #ccc;
  }

  .calendary-week-hour-cell {
    padding: 4px;
    border: 1px solid #ddd;
    text-align: right;
    font-size: 12px;
    background: #fafafa;
  }

  .calendary-week-time-slot {
    border: 1px solid #eee;
    height: 40px;
    position: relative;
  }

  .calendary-week-row {
    display: contents;
  }

  .calendary-week-column-day {
    background: #fff;
  }

  /* ðŸ”´ LÃ­nea roja para hora actual */
  .calendary-week-current-hour-line {
    position: absolute;
    height: 2px;
    background: rgb(250, 126, 126);
    width: calc(100% - 100px);
    /* 100px es la columna de horas */
    left: 100px;
    z-index: 10;
  }

  /* ðŸŒŸ Columna del dÃ­a actual */
  .calendary-week-today-column {
    background-color: #e0f7fa79 !important;
  }

  /* ðŸ“± AdaptaciÃ³n a mÃ³viles */
  @media (max-width: 768px) {
    .calendary-week-calendar {
      grid-template-columns: 60px repeat(7, minmax(60px, 1fr));
    }

    .calendary-week-header div {
      font-size: 10px;
      padding: 6px 2px;
    }

    .calendary-week-hour-cell {
      font-size: 8px;
      padding: 1px 2px;
    }

    .calendary-week-time-slot {
      height: 30px;
    }

    .calendary-week-current-hour-line {
      width: calc(100% - 60px);
      left: 60px;
    }
  }

  @media (max-width: 480px) {
    .calendary-week-calendar {
      grid-template-columns: 40px repeat(7, minmax(40px, 1fr));
    }

    .calendary-week-header div {
      font-size: 8px;
      padding: 4px 1px;
    }

    .calendary-week-hour-cell {
      font-size: 7px;
      padding: 1px;
    }

    .calendary-week-time-slot {
      height: 25px;
    }

    .calendary-week-current-hour-line {
      width: calc(100% - 40px);
      left: 40px;
    }
  }
</style>

<div id="calendary-week-calendar" class="calendary-week-calendar"></div>

<script>
  function renderWeek(dateStr) {
    //clear the calendar of all the old information
    const calendar = document.getElementById('calendary-week-calendar');
    calendar.innerHTML = '';
    const inputDate = new Date(dateStr);
    const weekStart = new Date(inputDate);
    weekStart.setDate(inputDate.getDate() - inputDate.getDay()); // Sunday


    //get all the appoint of this week
    const appointments = window.get_the_appointments_of_the_week(weekStart); //her get the appointments of the week

    const today = new Date();
    const isSameDay = (d1, d2) =>
      d1.getFullYear() === d2.getFullYear() &&
      d1.getMonth() === d2.getMonth() &&
      d1.getDate() === d2.getDate();

    const header = document.createElement('div');
    header.className = 'calendary-week-header';

    const hourHeader = document.createElement('div');
    hourHeader.textContent = '';
    header.appendChild(hourHeader);

    // Here we will get the days of the week in the language that the user uses
    const dayNames = [window.t('sunday'), window.t('monday'), window.t('tuesday'), window.t('wednesday'), window.t('thursday'), window.t('friday'), window.t('saturday')];

    const todayColumnIndices = [];

    for (let i = 0; i < 7; i++) {
      const day = new Date(weekStart);
      day.setDate(weekStart.getDate() + i);

      const dayDiv = document.createElement('div');
      dayDiv.textContent = `${dayNames[i]} ${day.getDate()}`;

      if (isSameDay(today, day)) {
        todayColumnIndices.push(i); // save here the day that is today
        dayDiv.style.backgroundColor = '#e0f7fa'; // also highlight in header
      }

      header.appendChild(dayDiv);
    }

    calendar.appendChild(header);

    for (let h = 0; h < 24; h++) {
      const hour = h.toString().padStart(2, '0');

      const row = document.createElement('div');
      row.className = 'calendary-week-row';

      const hourCell = document.createElement('div');
      hourCell.className = 'calendary-week-hour-cell';
      hourCell.textContent = `${hour}:00`;
      row.appendChild(hourCell);

      for (let d = 0; d < 7; d++) {
        const slot = document.createElement('div');
        slot.className = 'calendary-week-time-slot calendary-week-column-day';
        slot.dataset.day = d;
        slot.dataset.hour = h;

        // Si esta es la columna del dÃ­a actual, le aÃ±adimos la clase de fondo
        if (todayColumnIndices.includes(d)) {
          slot.classList.add('calendary-week-today-column');
        }

        row.appendChild(slot);
      }

      calendar.appendChild(row);
    }

    /////////////////////////////////////
    appointments.forEach(event => {
      const start = new Date(event.date_start);
      const end = new Date(event.date_finish);

      const dayIndex = start.getDay(); // 0=Sunday, 6=Saturday
      const startHour = start.getHours();
      const startMinutes = start.getMinutes();
      const durationHours = (end - start) / (1000 * 60 * 60); // duration in hours

      // Relative height: each hour = 1fr of the hour container
      const hourHeight = 4.1667; // 100% / 24 hours
      const top = startHour * hourHeight + (startMinutes / 60) * hourHeight;
      const height = durationHours * hourHeight;

      const eventDiv = document.createElement('div');
      eventDiv.className = 'calendary-week-event';

      // Adaptable position for all the devices
      eventDiv.style.position = 'absolute';
      eventDiv.style.top = `calc(${top}% + 4.5%)`; 
      eventDiv.style.width = `calc(${100 / 7 - 0.5}%)`; 


      //here we set the left position based on the day index. All the day need a specific offset
      if(dayIndex==0){
        eventDiv.style.left = `calc(${(dayIndex / 8) * 100}% + 8%)`;
      }
      else if (dayIndex==1){
        eventDiv.style.left = `calc(${(dayIndex / 8) * 100}% + 8.2%)`; 
        eventDiv.style.width = `calc(${100 / 7 - 0.5}%)`; 

      }
      else if (dayIndex==2){
        eventDiv.style.width = `calc(${100 / 7 - 0.9}%)`; 
        eventDiv.style.left = `calc(${(dayIndex / 8) * 100}% + 8.955%)`;
      }
      else if (dayIndex==5){
        eventDiv.style.width = `calc(${100 / 7 - 0.9}%)`; 
        eventDiv.style.left = `calc(${(dayIndex / 8) * 100}% + 11.1%)`;
      }
      else if (dayIndex==6){
        eventDiv.style.width = `calc(${100 / 7 - 0.9}%)`; 
        eventDiv.style.left = `calc(${(dayIndex / 8) * 100}% + 11.9%)`;
      }
      else{
        eventDiv.style.left = `calc(${(dayIndex / 8) * 100}% + 10%)`;
      }


      eventDiv.style.height = `${height}%`; //this is for the event duration

      // Background color
      const bgColor = event.appoints[0].type_appoint?.color || 'rgba(0, 123, 255, 0.2)';
      eventDiv.style.backgroundColor = bgColor;

      //---------
      // Automatic text contrast
      const rgb = bgColor.match(/\d+/g) || [0, 123, 255];
      const brightness = (parseInt(rgb[0]) * 299 + parseInt(rgb[1]) * 587 + parseInt(rgb[2]) * 114) / 1000;
      eventDiv.style.color = brightness > 125 ? 'black' : 'white';

      // Text style
      eventDiv.style.cursor = 'pointer';
      eventDiv.style.display = 'flex';
      eventDiv.style.flexDirection = 'column';
      eventDiv.style.alignItems = 'center';
      eventDiv.style.justifyContent = 'center';
      eventDiv.style.borderRadius = '6px';
      eventDiv.style.padding = '2%';
      eventDiv.style.overflow = 'hidden';
      eventDiv.style.textAlign = 'center';
      eventDiv.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';

      // container of the appointment
      const title = document.createElement('div');
      title.textContent = event.appoints[0].title;
      title.style.fontWeight = 'bold';
      title.style.fontSize = '1.1em';
      title.style.lineHeight = '1.2em';
      title.style.marginBottom = '0.2em';
      title.style.color = darkenColor(bgColor, 0.4);

      const legend = document.createElement('div');
      legend.textContent = event.appoints[0].type_appoint?.name || '';
      legend.style.fontSize = '0.8em';
      legend.style.opacity = '0.8';
      legend.style.color = darkenColor(bgColor, 0.3);


      const priorityContainer = document.createElement('div');
      priorityContainer.style.display = 'flex';
      priorityContainer.style.justifyContent = 'center';
      priorityContainer.style.marginTop = '0.2em';

      //here we will show the level of the priority of the appointment
      const priority = event.appoints[0].priority || 0; 
      if(priority>0){
        for (let i = 0; i < 3; i++) {
          const star = document.createElement('span');
          star.textContent = 'â˜…'; // estrella
          star.style.fontSize = '0.9em';
          star.style.margin = '0 1px';
          
          // color: lleno si menor que prioridad, transparente si no
          if (i <= priority) {
            star.style.color = 'gold';
          } else {
            star.style.color = 'rgba(255, 215, 0, 0.3)'; // mÃ¡s transparente
          }

          priorityContainer.appendChild(star);
        }
      }



      //-----show the hours of the event when the user 
      // Tooltip with the time
      const startHourStr = start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const endHourStr = end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const tooltipText = `${startHourStr} - ${endHourStr}`;

      // Create a div for the tooltip
      const tooltip = document.createElement('div');
      tooltip.className = 'event-tooltip';
      tooltip.textContent = tooltipText;
      tooltip.style.position = 'absolute';
      tooltip.style.padding = '4px 8px';
      tooltip.style.backgroundColor = 'rgba(0,0,0,0.7)';
      tooltip.style.color = 'white';
      tooltip.style.borderRadius = '4px';
      tooltip.style.fontSize = '12px';
      tooltip.style.pointerEvents = 'none';
      tooltip.style.visibility = 'hidden';
      tooltip.style.zIndex = '1000';
      document.body.appendChild(tooltip); //add the tooltip to the body


      // show the tooltip to move the mouse for one of the events
      //with this we will show the duration of the event
      eventDiv.addEventListener('mouseenter', e => {
        tooltip.style.visibility = 'visible';
        tooltip.style.left = e.pageX + 10 + 'px'; // 10px to the right of the cursor
        tooltip.style.top = e.pageY + 10 + 'px';  // 10px below the cursor
      });

      eventDiv.addEventListener('mousemove', e => {
        tooltip.style.left = e.pageX + 10 + 'px';
        tooltip.style.top = e.pageY + 10 + 'px';
      });

      eventDiv.addEventListener('mouseleave', () => {
        tooltip.style.visibility = 'hidden';
      });

      // Show the character of the event when the user do click
      eventDiv.addEventListener('click', async () => {
        await show_character_appoint(event.appoints[0].id);
      });













      //add the tooltip
      eventDiv.appendChild(title);
      eventDiv.appendChild(legend);
      eventDiv.appendChild(priorityContainer);
      calendar.appendChild(eventDiv);
    });
    


    //Red line of the current time for show the hour current of the user for that the user know that evenet next 
    const redLine = document.createElement('div');
    redLine.className = 'calendary-week-current-hour-line';
    if (today >= weekStart && today <= new Date(weekStart.getTime() + 6 * 86400000)) {
      const hours = today.getHours();
      const minutes = today.getMinutes();
      const positionY = (hours * 40) + (minutes / 60 * 40); // a hour is equal to 40px

      redLine.style.top = `${positionY + 40}px`; // +40 for the header
      redLine.style.width = "100%";
      redLine.style.height = "2px";
      redLine.style.background = "red";
      redLine.style.position = "absolute";
      redLine.style.left = "0";
    } else {
      redLine.style.display = "none"; // if not is the week current not show the line
    }

    calendar.appendChild(redLine);
  }

  function update_line(){
    const today = new Date();
    const lines = document.querySelectorAll('.calendary-week-current-hour-line');
    
    lines.forEach(line => {
      const hours = today.getHours();
      const minutes = today.getMinutes();
      const positionY = (hours * 40) + (minutes / 60 * 40); // a hour is equal to 40px

      line.style.top = `${positionY + 40}px`; // +40 for header
    });
  }

  function darkenColor(color, amount = 0.3) {
    // color puede ser "rgb(r,g,b)" o "#rrggbb"
    let r, g, b;

    if (color.startsWith('#')) {
      r = parseInt(color.slice(1,3),16);
      g = parseInt(color.slice(3,5),16);
      b = parseInt(color.slice(5,7),16);
    } else if (color.startsWith('rgb')) {
      const nums = color.match(/\d+/g);
      r = parseInt(nums[0]);
      g = parseInt(nums[1]);
      b = parseInt(nums[2]);
    } else {
      // color desconocido, fallback
      return '#000';
    }

    // oscurecemos multiplicando por (1-amount)
    r = Math.max(Math.min(Math.floor(r * (1 - amount)), 255), 0);
    g = Math.max(Math.min(Math.floor(g * (1 - amount)), 255), 0);
    b = Math.max(Math.min(Math.floor(b * (1 - amount)), 255), 0);

    return `rgb(${r},${g},${b})`;
  }

  function render_this_day() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const todayStr = `${yyyy}-${mm}-${dd}T00:00:00`;

    renderWeek(todayStr);
  }

  setInterval(update_line, 60000); //update the line for minute 
  window.render_this_day = render_this_day;
</script>
