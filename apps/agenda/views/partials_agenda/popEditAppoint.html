<message-pop title="title-pop-edit-event" name="pop-edit-event">
<div class="container-pop">
    <form  id="formEditEvent">
    <plus-tabs>
        <plus-tab text="Description">
            <input type="hidden" name="id_event" id="id_event"/>
            <div class="section">
                <label t="label-input-title">Title of the event</label>
                <input type="text" name="name_event" class="case-title-input" placeholder="Title"
                    t-placeholder="placeholder-input-title" required maxlength="300" id="title_event"/>
            </div>

            <div class="section">
                <div class="row m-1">
                    <plus-select label="priority" name="priority" id="priority_edit"  required>
                        <option selected t="priority.low" value="0"></option>
                        <option t="priority.normal" value="1"></option>
                        <option t="priority.high" value="2"></option>
                    </plus-select>

                    <plus-select label="search-type-event" name="type_event" required id="type_appoint_edit"
                        link="agenda/get_the_first_type_events/" add="open_pop_new_type_event" edit_data="edit_data"
                        delete_data="agenda/delete_type_event/" btn_delete_title="message.delte-type-event-title" btn_delete_text="message.delte-type-event-description">
                    </plus-select>
                </div>
            </div>

            <div class="section">
                <plus-switch text="all-day" id="activate_event_all_the_day_edit" name="activate_event_all_the_day_edit" onclick="activate_event_all_the_day_edit"></plus-switch>
                <label t="starts" style="margin-bottom: -24px; display: block;"></label>
                <div class="row section">
                    <plus-date label="starts" name="start_date_edit" id="start_date_edit"></plus-date>
                    <plus-time label="min-start" name="start_time_edit" id="start_time_edit"></plus-time>
                </div>

                <label t="ends" style="margin-bottom: -24px; display: block;"></label>
                <div class="row section">
                    <plus-date label="ends" name="end_date_edit" id="end_date_edit"></plus-date>
                    <plus-time label="min-end" name="end_time_edit" id="end_time_edit"></plus-time>
                </div>

            </div>

            <div class="section">
                <plus-select label="time-of-alert" name="alert_time" required id="alert_time_edit">
                    <option selected t="alert.none" value="0"></option>
                    <option t="alert.5min" value="5"></option>
                    <option t="alert.10min" value="10"></option>
                    <option t="alert.15min" value="15"></option>
                    <option t="alert.30min" value="30"></option>
                    <option t="alert.1hr" value="60"></option>
                    <option t="alert.2hr" value="120"></option>
                    <option t="alert.1day" value="1440"></option>
                    <option t="alert.2day" value="2880"></option>
                    <option t="alert.1week" value="10080"></option>
                </plus-select>
            </div>

            <div class="section">
                <info-label label="emails-guests"
                    message="email-message-show"></info-label>
                <plus-tags id="emails_guests_edit" name="emails_guests" label="emails-guests" message="email-message-show" t-placeholder="input.add-most-email"></plus-tags>
            </div>

            <div class="section">
                <label for="description" t="label-description">Description</label>
                <textarea name="description" id="edit_description" rows="4"
                    t-placeholder="placeholder-description"></textarea>
            </div>


        </plus-tab>


        <plus-tab text="More options">
            <div class="section">
                <input-field label="label-input-address" name="location" id="edit_location"
                    placeholder="placeholder-input-address"></input-field>
            </div>

            <div class="section">
                <input-field label="label-link" type="text" name="link" id="edit_link" placeholder="www/..."></input-field>
            </div>


            <plus-switch text="repeat_this_event" name="repeat_this_event" id="repeat_this_event_edit"
                onclick="hidden_input_repet_edit"></plus-switch>

            <div class="section" id="hidden_input_repet_edit" style="display: none;">
                <div class="row m-1">
                    <plus-select label="repeat" name="time_repeat" requerid id="time_repeat_edit">
                        <option selected t="option.never" value="0"></option>
                        <option t="option.every_day" value="1"></option>
                        <option t="option.every_week" value="7"></option>
                        <option t="option.every_2_weeks" value="15"></option>
                        <option t="option.every_month" value="30"></option>
                        <option t="option.every_year" value="365"></option>
                    </plus-select>


                    <plus-select label="endRepeat" name="time_end_repeat" requerid id="time_end_repeat_edit">
                        <option selected t="option.never" value="0">Never</option>
                        <option t="option.on_day" value="1">On Day</option>
                        <option t="option.on_week" value="7">A week</option>
                        <option t="option.on_2_weeks" value="15">Two week</option>
                        <option t="option.on_month" value="30">A Month</option>
                        <option t="option.on_year" value="365">A Year</option>
                    </plus-select>
                </div>

            </div>

            <plus-switch text="send_notification" name="send_notification" checked="true"></plus-switch>

            <plus-switch text="i_am_free" name="i_am_free" checked="true"></plus-switch>
        </plus-tab>
    </plus-tabs>
    </form>
</div>

<button class="btn btn-edit btn-success" t="btn.update" onclick="update_event()" type="button">Save</button>
</message-pop>



<script>
    //this functions is for update the event when the user do click on the button save
    async function update_event() {
        //first we will get all the information from the form
        const form = document.getElementById('formEditEvent');
        const formData = new FormData(form);

        //convert the formData to a json object
        const data = {};
        formData.forEach((value, key) => {
            data[key] = value;
        });
        console.log(JSON.stringify(data, null, 2));

        //send the information to the server for update the event
        const answer = await window.send_message_to_the_server('/agenda/edit_event/', data);

        //if can added the new event, now we will show a message of confirmation and clear the form 
        if (answer.success) {
            //hide the pop and refresh the calendar 
            hide_pop('pop-edit-event');

            //refresh the calendar 
            if (typeof refresh_calendar === 'function') {
                refresh_calendar();
            }

            await window.update_all_the_information_of_my_calendary();
            //show a message of success 
            show_alert('success', window.translate_text('message.update-new-event.success'), window.translate_text('message.update-new-event.success.description'));
        } else {
            //show a message of error 
            console.log(answer)
            show_alert('error', window.translate_text("message.error_in_server"), window.translate_text(answer.message), answer.error);
        }
    }

    //this functions is call when the user do click in the switch for activate the appoint all the day 
    function activate_event_all_the_day_edit(status) {
        //her also update the information of the minutes for get the time 
        window.change_plus_time('start_time_edit', '00:00');
        window.change_plus_time('end_time_edit', '23:59');
    }

    function this_event_is_activate_all_the_day(date_start, date_finish) {
        const start = new Date(date_start);
        const finish = new Date(date_finish);

        // mismo día (año, mes, día)
        const sameDay = start.getFullYear() === finish.getFullYear() &&
                        start.getMonth() === finish.getMonth() &&
                        start.getDate() === finish.getDate();

        // inicio a las 00:00
        const startsAtMidnight = start.getHours() === 0 && start.getMinutes() === 0 && start.getSeconds() === 0;

        // fin a las 23:59 (o 23:59:59)
        const endsAtEndOfDay = 
            (finish.getHours() === 23 && finish.getMinutes() === 59) ||
            (finish.getHours() === 23 && finish.getMinutes() === 59 && finish.getSeconds() === 59);

        return sameDay && startsAtMidnight && endsAtEndOfDay;
    }

    function hidden_input_repet_edit(status) {
        const inputRepet = document.getElementById('hidden_input_repet_edit');
        if (status) {
        inputRepet.style.display = 'block';
        } else {
        inputRepet.style.display = 'none';
        }
    }

    function day_for_finish_the_event(date1,date2){
        const dateStart = new Date(date1);
        const finishRepeatDate = new Date(date2);

        // get the difference in milliseconds
        const diffMs = finishRepeatDate - dateStart;

        //convert to days
        const diffDays = diffMs / (1000 * 60 * 60 * 24);
        return diffDays;
    }

    //this functions is for show the character of the appointment when the user do click on a event
    window.show_character_appoint = async function(id) {
        const answer=await window.send_message_to_the_server(`/agenda/get_appointment_by_id/`,{id}, true, 'GET');

        if(answer.success){
            const dataAppoints=answer.data;
            console.log(JSON.stringify(dataAppoints, null, 2));
            
            //update the information of the appoint 
            document.getElementById('id_event').value=dataAppoints.id || '';
            document.getElementById('title_event').value=dataAppoints.title || '';
            window.set_value_plus_select('priority_edit', dataAppoints.priority || '0');
            window.set_value_plus_select('type_appoint_edit', dataAppoints.type_appoint.id || '', dataAppoints.type_appoint.name || '');

            //here we will to update the format date in the form
            const date_start=dataAppoints.date_start || '';
            const date_finish=dataAppoints.date_finish || '';

            const statusActivateAllTheDay=this_event_is_activate_all_the_day(date_start, date_finish) || false;
            window.set_status_plus_switch('activate_event_all_the_day_edit',statusActivateAllTheDay);
            activate_event_all_the_day_edit(statusActivateAllTheDay);

            window.update_input_date_and_time('start_date_edit','start_time_edit',date_start)
            window.update_input_date_and_time('end_date_edit','end_time_edit',date_finish)
            window.set_value_plus_select('alert_time_edit', dataAppoints.time_alert || '0');

            //her update the information of contact of the appointment
            document.getElementById('edit_description').value=dataAppoints.description || '';
            document.getElementById('edit_location').value=dataAppoints.location || '';
            document.getElementById('edit_link').value=dataAppoints.link || '';

            window.set_status_plus_switch('repeat_this_event_edit',dataAppoints.repeat_this_event || false);
            hidden_input_repet_edit(dataAppoints.repeat_this_event || false);

            window.set_value_plus_select('time_repeat_edit', dataAppoints.time_repeat || '0');
            window.set_value_plus_select('time_end_repeat_edit', day_for_finish_the_event(dataAppoints.date_start, dataAppoints.finish_repeat_date));

            document.getElementById('emails_guests_edit').setTags(Array.isArray(dataAppoints.emails_guests) ? dataAppoints.emails_guests : JSON.parse(dataAppoints.emails_guests || '[]'));
            open_my_pop('pop-edit-event');
        }
  };



</script>