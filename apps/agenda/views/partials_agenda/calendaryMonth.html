<style>
    .calendar {
        background-color: transparent;
        border-radius: 20px;
        padding: 20px;
        max-width: 420px;
        width: 100%;
        overflow-x: auto;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .calendar-header h2 {
        margin: 0;
        font-size: 1.4rem;
        color: var(--primary);
    }

    .nav-buttons button {
        background-color: transparent;
        color: var(--primary);
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 8px;
        transition: background 0.2s;
    }

    .nav-buttons button:hover {
        background-color: #f0f0f0;
    }

    .day-names,
    .days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        gap: 10px;
    }

    .day-names div {
        font-weight: bold;
        color: #888;
    }

    .days div {
        padding: 10px 0;
        border-radius: 10px;
        transition: all 0.2s;
        cursor: default;
    }

    .days div.today {
        background-color: var(--primary);
        color: white;
        font-weight: bold;
    }

    .days div:hover {
        background-color: #f0f0f5;
    }

    .days div.empty {
        visibility: hidden;
    }

    .title-number-day {
        font-size: 5rem;
    }

    .title-day {
        font-size: 2.5rem;
    }

   /* üì± Media Queries para celulares */
    @media (max-width: 768px) {
        .calendar {
            padding: 15px;
        }

        .day-names div,
        .days div {
            font-size: 0.8rem;
        }

        .title-number-day {
            font-size: 4rem;
        }

        .title-day {
            font-size: 2rem;
        }

        .nav-buttons button {
            font-size: 1rem;
            padding: 4px 8px;
        }

        .calendar-header h2 {
            font-size: 1.2rem;
        }
    }

    @media (max-width: 480px) {
        .calendar {
            padding: 10px;
        }

        .day-names,
        .days {
            gap: 5px;
        }

        .day-names div,
        .days div {
            font-size: 0.7rem;
            padding: 6px 0;
        }

        .title-number-day {
            font-size: 3rem;
        }

        .title-day {
            font-size: 1.5rem;
        }

        .nav-buttons button {
            font-size: 0.9rem;
            padding: 3px 6px;
        }

        .calendar-header h2 {
            font-size: 1rem;
        }
    }
</style>

<br>
<label class="title-number-day" id="numberDay">1</label>
<label class="title-day" id="textDay">FRI</label>
<button class="btn btn-normal" id="btnTodayCalendaryMonth" t="range.today">Today</button>


<div class="calendar">
    <div class="calendar-header">
        <div class="nav-buttons">
            <button onclick="window.changeMonth(-1)">‚ùÆ</button>
        </div>
        <h2 id="month-year"></h2>
        <div class="nav-buttons">
            <button onclick="window.changeMonth(1)">‚ùØ</button>
        </div>
    </div>
    <div class="day-names">
        <div>Sun</div>
        <div>Mon</div>
        <div>Tue</div>
        <div>Wed</div>
        <div>Thu</div>
        <div>Fri</div>
        <div>Sat</div>
    </div>
    <div class="days" id="calendar-days"></div>
</div>

<script>
    (async () => {
        let currentDate = new Date(); // Global variable for know in that date be



        function change_info_language() {
            //get the days in his language
            const dayNames = [
                window.translate_text('date.sunday'),
                window.translate_text('date.monday'),
                window.translate_text('date.tuesday'),
                window.translate_text('date.wednesday'),
                window.translate_text('date.thursday'),
                window.translate_text('date.friday'),
                window.translate_text('date.saturday')
            ];

            //her get the divs where is the days
            const dayNamesDivs = document.querySelectorAll('.day-names div');
            for (let i = 0; i < dayNamesDivs.length; i++) {
                dayNamesDivs[i].textContent = dayNames[i]; //update the text
            }
        }

        function update_text_day(numberDay) {
            document.getElementById('numberDay').textContent = numberDay;
            document.getElementById('textDay').textContent = ''
        }



        function renderCalendar(date) {
            const monthYearText = document.getElementById('month-year');
            const daysContainer = document.getElementById('calendar-days');

            const year = date.getFullYear();
            const month = date.getMonth();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const today = new Date();

            monthYearText.textContent = date.toLocaleDateString('es-MX', {
                month: 'long',
                year: 'numeric'
            });

            daysContainer.innerHTML = '';

            const startDay = firstDay.getDay();
            for (let i = 0; i < startDay; i++) {
                const empty = document.createElement('div');
                empty.classList.add('empty');
                daysContainer.appendChild(empty);
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayElement = document.createElement('div');
                dayElement.textContent = day;

                // ‚úÖ Marca el d√≠a actual
                if (
                    today.getFullYear() === year &&
                    today.getMonth() === month &&
                    today.getDate() === day
                ) {
                    dayElement.classList.add('today');
                }

                // ‚úÖ Evento al hacer clic en un d√≠a
                dayElement.addEventListener('click', () => {
                    const clickedDate = new Date(year, month, day);
                    renderWeek(clickedDate);
                    update_text_day(day)
                });

                daysContainer.appendChild(dayElement);
            }
        }

        function changeMonth(step) {
            currentDate.setMonth(currentDate.getMonth() + step); // We use the global variable
            renderCalendar(currentDate);
        }

        function get_month_current() {
            return currentDate.getMonth();
        }


        document.getElementById('btnTodayCalendaryMonth').addEventListener('click', () => {
            currentDate = new Date(); // restart to the day
            renderCalendar(currentDate);
        });





        //---------------------------------------------------now get information of the agenda in the backend--------------------------------------
        let listAppoints=[
            { date: '', appoints: [] },
            { date: '', appoints: [] }, //here is the month 
            { date: '', appoints: [] }
        ]; //here we will save the information of the events
        listAppoints=[];

        async function get_the_information_of_the_calendary(){
            //first we will get the range of date that need get
            const monthCurrent=get_month_current();
            const { startDate, endDate } = get_month_range(monthCurrent);

            //now need see if exist the data in the list for render in the agenda
            const existDataCurrentMonth=listAppoints.find(item=>item.month===monthCurrent);

            //now with the information of the next and the previous month we can get the events from the server
            const response = await send_message_to_the_server('/agenda/get_events_by_date_range/', {
                start_date: startDate,
                end_date: endDate
            }, false, 'GET');



            if (response.success) {
                add_this_information_to_the_appointments_list(response.data); //update the list with the new information
            } else {
                console.error('Error al obtener la informaci√≥n del calendario:', response.error);
            }
        }

        //this function is for create the range of date use a month and get the start and end date
        //of the next month and the after month
        function get_month_range(date) {
            const currentDate = new Date();
            date=currentDate;
            const year = date.getFullYear();
            const month = date.getMonth();

            //first day of the month after
            const startDate = new Date(year, month - 1, 1);

            // last day of the month after
            const endDate = new Date(year, month + 2, 0);

            return { startDate, endDate };
        }

        //this functions is for update the list of appointments when need update a month in the calendar
        function update_appointments_list(date, appointments) {
            // Extract month and year from the date
            const month = date.getMonth();
            const year = date.getFullYear();

            // Find the month entry in the list
            const monthEntry = listAppoints.find(item => item.month === month && item.year === year);

            if (monthEntry) {
                monthEntry.appoints = appointments;
            } else {
                // If the month entry doesn't exist, create a new one
                listAppoints.push({
                    month,
                    year,
                    appoints: appointments
                });
            }
        }

        function add_this_information_to_the_appointments_list(appointments) {
            //now we will to read all the information of the list and add the new appointments with his month
            appointments.forEach(appointment => {
                const { date, ...rest } = appointment;

                //here we get the start and finish date
                const date_start = new Date(rest.date_start);
                const date_finish = new Date(rest.date_finish);
                const id=rest.id;
                
                //now we will see if the appointment already exists
                listAppoints.push({ id, date_start, date_finish, appoints: [rest] });
            });
        }

        function get_the_list_of_appointments() {
            return listAppoints;
        }

        function get_the_appointments_of_the_week(weekStart) {
            const startOfWeek = new Date(weekStart);
            startOfWeek.setHours(0, 0, 0, 0);

            const endOfWeek = new Date(weekStart);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);

            return listAppoints.filter(item => {
                const date_start = new Date(item.date_start); // usa date_start para comparar
                const date_finish = new Date(item.date_finish); // usa date_finish para comparar
                return date_start >= startOfWeek && date_finish <= endOfWeek;
            });
        }

        ////-------------------------------------------------
        await get_the_information_of_the_calendary(); //first get the information of the calendar
        change_info_language(); //second we will translate the text of the agenda
        update_text_day( currentDate.getDate())
        renderCalendar(currentDate); // ‚úÖ Start with the global variable
        


        window.get_the_appointments_of_the_week=get_the_appointments_of_the_week;
        window.changeMonth = changeMonth;
        window.get_the_list_of_appointments = get_the_list_of_appointments;
        window.get_month_current = get_month_current;


        window.render_this_day();
    })();
</script>