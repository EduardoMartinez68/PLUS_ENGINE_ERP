<style>
.avatar-member{
    width: 40px;
    height: 40px;
}
</style>


<message-pop name="pop-member-folder" title="files.title.member-folder">
    <plus-search input_id="search-member-folder" label="files.label.member" placeholder="files.placeholder.search-member-folder">
        <search-option>
            <button class="btn btn-add" onclick="open_pop_add_new_member_folder()">+</button>
        </search-option>
    </plus-search>

        <table>
            <thead>
                <tr>
                    <th style="width:10%;"></th>
                    <th style="width:20%;" t="files.th.username"></th>
                    <th style="width:25%;" t="files.th.email"></th>
                    <th style="width:25%;" t="files.th.member"></th>
                    <th style="width:10%;"></th>
                    <th style="width:10%;"></th>
                </tr>
            </thead>
            <tbody id="container-table-member-folder">
            </tbody>
        </table>
</message-pop>

<message-pop name="pop-add-member-folder" title="files.title.add-member-folder">
    <form id="form-member-folder">
        <input type="hidden" id="folder-id-member-folder" name="folder_id">
        <input type="hidden" id="folder-id-creator-folder">
        <div class="row">
            <div class="col">
                <plus-select name="member_id" id="member_id" label="files.label.member" 
                link="/departament_employee/search_employee/" method="GET"
                ></plus-select>
            </div>
        </div>
        <plus-switch text="files.permission.activate-all" onclick="activate_all_permittions_of_the_folder"></plus-switch>
        <div class="row">
            <div class="col">
                <plus-switch text="files.permission.view" name="can_see_the_files"></plus-switch>
                <plus-switch text="files.permission.edit" name="can_edit_folder"></plus-switch>
                <plus-switch text="files.permission.delete" name="can_delete_folder"></plus-switch>
                <plus-switch text="files.permission.download" name="can_download_folder"></plus-switch>

                <plus-switch text="files.permission.see-member" name="can_see_members"></plus-switch>
                <plus-switch text="files.permission.add-member" name="can_add_members"></plus-switch>
                <plus-switch text="files.permission.edit-member" name="can_change_the_permission"></plus-switch>

                
            </div>
            <div class="col">
                <plus-switch text="files.permission.upload-files" name="can_upload_file"></plus-switch>
                <plus-switch text="files.permission.edit-files" name="can_update_file"></plus-switch>
                <plus-switch text="files.permission.download-files" name="can_download_file"></plus-switch>
                <plus-switch text="files.permission.delete-files" name="can_delete_file"></plus-switch>

                <plus-switch text="files.permission.add-subfolder" name="can_add_subfolder"></plus-switch>
                <plus-switch text="files.permission.delete-member" name="can_delete_members"></plus-switch>
            </div>
        </div>
        <button class="btn btn-add btn-success" t="files.btn.add-member-folder" onclick="add_new_member_to_the_folder()" type="button"></button>
    </form>
</message-pop>

<message-pop name="pop-edit-member-folder" title="files.title.edit-member-folder">
    <form id="form-edit-member-folder">
        <input type="hidden" id="member-edit" name="member_id">
        <input type="hidden" id="folder-id-edit" name="folder_id">
        <div class="row">
            <div class="col">
                <plus-title value="Jessica" id="name-member-edit" label="files.title.name-member-folder"></plus-title>
            </div>
        </div>
        <plus-switch text="files.permission.activate-all" onclick="activate_all_permittions_of_the_folder_edit" id="edit-activate-all-the-permissions"></plus-switch>
        <div class="row">
            <div class="col">
                <plus-switch text="files.permission.view" name="can_see_the_files"></plus-switch>
                <plus-switch text="files.permission.edit" name="can_edit_folder"></plus-switch>
                <plus-switch text="files.permission.delete" name="can_delete_folder"></plus-switch>
                <plus-switch text="files.permission.download" name="can_download_folder"></plus-switch>

                <plus-switch text="files.permission.see-member" name="can_see_members"></plus-switch>
                <plus-switch text="files.permission.add-member" name="can_add_members"></plus-switch>
                <plus-switch text="files.permission.edit-member" name="can_change_the_permission"></plus-switch>

                
            </div>
            <div class="col">
                <plus-switch text="files.permission.upload-files" name="can_upload_file"></plus-switch>
                <plus-switch text="files.permission.edit-files" name="can_update_file"></plus-switch>
                <plus-switch text="files.permission.download-files" name="can_download_file"></plus-switch>
                <plus-switch text="files.permission.delete-files" name="can_delete_file"></plus-switch>

                <plus-switch text="files.permission.add-subfolder" name="can_add_subfolder"></plus-switch>
                <plus-switch text="files.permission.delete-member" name="can_delete_members"></plus-switch>
            </div>
        </div>
        <button class="btn btn-edit btn-success" t="btn.update" onclick="update_member_in_the_folder()" type="button"></button>
    </form>
</message-pop>

<script>
    function get_div_container_member_folder() {
        return `
            <td> <img class='avatar-member' src="{ avatar }" alt="{ username }'s avatar"> </td>
            <td>
                { username }
            </td>
            <td>
                { email }
            </td>
            <td>
                { member_name }
            </td>
            <td>
                <button class="btn btn-transparent" onclick='open_pop_edit_member_folder(" { member_name } ", { id } )'><i class="fi fi-sr-user-pen"></i></button>
            </td>
            <td>
                <button class="btn btn-transparent" onclick='delete_member_folder( { id } )'><i class="fi fi-sr-trash"></i></button>
            </td>
        `;
    }


    function activate_all_permittions_of_the_folder(value) {
        const pop=document.getElementById('pop-add-member-folder');
        const switches=pop.querySelectorAll('plus-switch');
        switches.forEach((sw)=>{
            sw.setChecked(value);
        });
    }

    function activate_all_permittions_of_the_folder_edit(value) {
        const pop=document.getElementById('pop-edit-member-folder');
        const switches=pop.querySelectorAll('plus-switch');
        switches.forEach((sw)=>{
            sw.setChecked(value);
        });
    }

    function open_pop_add_new_member_folder(){
        //now we will open the pop
        activate_all_permittions_of_the_folder(false); //we will deactivate all the permissions by default
        document.getElementById('member_id').reset();
        window.show_pop('pop-add-member-folder');
    }

    async function open_pop_edit_member_folder(name, member_id){
        //first we will see the user not tyr get the permissions of the creator 
        if(document.getElementById('folder-id-creator-folder').value==member_id){
            window.show_alert('alert', 'files.error.error-to-get-the-permition', 'files.error.the-creator-have-all-the-permissions', 'the user not can get the permissions of the creator for change his permissions')
            return;
        }

        //first we will get the permits of the user in the folder 
        const folder_id=document.getElementById('folder-id-member-folder');
        if(folder_id.value==''){
            window.show_alert('alert', 'files.error.error-to-get-the-permition', 'files.error.not-exit-the-folder-id', 'Need The id of the folder');
            return;
        }

        const backend=await send_message_to_the_server(`files/get_permitions_member/${folder_id.value}/${member_id}/`, {}, true, 'GET');
        //we will see if not get the permits of the server
        if(!backend.success){
            window.show_alert('alert', 'files.error.error-to-get-the-permition', backend.message, backend.error || '');
            return;
        }


        //if get the permittions, now we will to update the select and show the permittions
        const permissions = backend.answer; // get all the permissions of the user
        const form = document.getElementById("form-edit-member-folder");

        //check if exist the form
        if (!form) {
            window.show_alert('alert', 'files.error.error-to-get-the-permition', 'The form not exit', 'The form not exit');
            return;
        }

        // read all the <plus-switch> in the form
        let allActive = true;
        const switches = form.querySelectorAll("plus-switch[name]");
        switches.forEach(sw => {
            //here we will see if exist the permission in the answer of the server
            //if exist we activate the permission else we off the check
            const name = sw.getAttribute("name");
            if (name in permissions) {
                sw.setChecked(permissions[name]);
                if(!permissions[name]){
                    allActive = false;
                }
            } else {
                sw.setChecked(false);
                allActive = false;
            }
        });

        //we will activate the switch global for activate all the permissions if this user have all the permissions of the folder
        const activateAll = document.getElementById("edit-activate-all-the-permissions");
        if (activateAll && typeof activateAll.setChecked === "function") {
            activateAll.setChecked(allActive);
        }
        
        document.getElementById('name-member-edit').value=name; //update the name of the member
        document.getElementById('member-edit').value=member_id; //update the id of the member to update
        document.getElementById('folder-id-edit').value=document.getElementById('folder-id-member-folder').value;
        window.show_pop('pop-edit-member-folder'); 
    }   

    async function add_new_member_to_the_folder(){
        const new_member_id=window.get_value_plus_select('member_id');
        const creator_id=document.getElementById('folder-id-creator-folder').value;

        //first we will to check if exist the id for the new member
        if(new_member_id==''){
            window.show_alert('alert', 'files.error.error-to-add-member', 'files.error.need-add-the-member', 'Need add the new member');
            return;    
        }


        //second we will see if the id of the new member not is equal to the id of the creator
        if(new_member_id==creator_id){
            window.show_alert('alert', 'files.error.error-to-add-member', 'files.error.cannot-add-creator-folder', 'the user not can add to the creator of the folder');
            return;
        }

        //now we will to send the form to the server and get the response
        const backend=await send_form_to_the_server('form-member-folder', '/files/view_add_member_folder/');
        if(backend.success){
            //if the response is successful, we will refresh the container and close the pop 
            window.refresh_container_from_the_server(
                ['search-member-folder', 'folder-id-member-folder'],
                'container-table-member-folder',
                get_div_container_member_folder(),
                '/files/members_of_folder/',
                'GET'
            );

            window.hide_pop('pop-add-member-folder');
            window.show_alert('success', 'files.title.member-folder-added', 'files.message.member-folder-added');
            return;
        }

        //if not can add the new member we will show a alert
        window.show_alert('alert', 'files.error.error-to-add-member', backend.message || '', backend.error || '');
    }

    async function update_member_in_the_folder(){
        const creator_id=document.getElementById('folder-id-creator-folder').value;
        const member_id=document.getElementById('member-edit').value;

        //first we will to check if exist the id for the new member
        if(member_id==''){
            window.show_alert('alert', 'files.title.no-can-update-the-member', 'files.error.need-add-the-member', 'the user not can update the permissions of the creator')
            return;    
        }


        //second we will see if the id of the new member not is equal to the id of the creator
        if(member_id==creator_id){
            window.show_alert('alert', 'files.title.no-can-update-the-member', 'files.error.the-creator-have-all-the-permissions', 'the user not can update the permissions of the creator')
            return;
        }

        //now we will to send the form to the server and get the response
        const backend=await send_form_to_the_server('form-edit-member-folder', '/files/view_update_member_in_the_folder/');
        if(backend.success){
            window.hide_pop('pop-edit-member-folder');
            window.show_alert('success', 'files.title.the-member-was-update', 'files.message.the-member-was-update');
            return;
        }

        //if not can add the new member we will show a alert
        window.show_alert('alert', 'files.title.no-can-update-the-member', backend.message || '', backend.error || '');
    }

    async function delete_member_folder(member_id) {
        //first we will see if the id of the member not is null also that not is the id of the user
        if(member_id==null || member_id==''){
            window.show_alert('alert', 'files.error.error-to-delete-member', 'files.error.not-exist-member', 'the user not exist in this folder. The id is null or empty')
            return;
        }

        if(document.getElementById('folder-id-creator-folder').value==member_id){
            window.show_alert('alert', 'files.error.error-to-delete-member', 'files.error.cannot-delete-creator-folder', 'the user not can delete to the creator of the folder')
            return;
        }

        //now we will to do a question to the user if would like to delete the member
        const folder_id=document.getElementById('folder-id-member-folder').value;
        if(await plus_delete_with_help_button(
            member_id, 
            `files/view_delete_member_folder/${folder_id}/`, 
            'files.question.delete-member-folder', 
            'files.message.delete-member-folder' ,
            'files.title.member-delete-of-the-folder', 
            'files.message.member-delete-of-the-folder')
        ){
            //if the user confirm the deletion, we will refresh the container
            window.refresh_container_from_the_server(
                ['search-member-folder', 'folder-id-member-folder'],
                'container-table-member-folder',
                get_div_container_member_folder(),
                '/files/members_of_folder/',
                'GET'
            );

            window.show_alert('success', 'files.title.member-delete-of-the-folder', 'files.message.member-delete-of-the-folder')
        }
    }


    //when the user open the pop of the member we will to load the container
    window.update_container_with_seeker(
        ['search-member-folder', 'folder-id-member-folder'],
        'container-table-member-folder',
        get_div_container_member_folder(),
        '/files/members_of_folder/',
        'GET'
    )
</script>